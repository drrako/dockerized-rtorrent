#!/usr/bin/env sh

check_processes() {
    if ! pgrep -f "s6-supervise rtorrent" > /dev/null && \
       ! pgrep -f "s6-supervise php-fpm" > /dev/null && \
       ! pgrep -f "s6-supervise nginx" > /dev/null; then
        return 1
    fi
    return 0
}

kill_socklog() {
    pid=$(pgrep -f "socklog unix /dev/log")
    if [ -n "$pid" ]; then
        echo "Killing socklog process with PID: $pid"
        kill -9 "$pid"
    else
        echo "socklog process not found"
    fi
}

echo "socklog-killer: launching socklog shutdown killer script, waiting for rtorrent to start.."

while true; do
    s6-svwait /var/run/s6/services/rtorrent > /dev/null 2>&1
    if [ $? -eq 0 ]; then
        echo "socklog-killer: rtorrent is up, starting polling.."
        break
    else
        sleep 1
    fi
done

while true; do
    if ! check_processes; then
        kill_socklog
    fi
    sleep 2
done
